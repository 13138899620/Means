<?php
/**
 * 获取网页内容
 * @param $url
 * @param $cache
 * @return mixed|string
 */
function http_get_content($url, $cache = false){
	// 定义当前页面请求的cache key
	$key = md5($url);
	// 如果使用cache时只读一次
	if($cache){
		$file_contents = $_SESSION[$key];
		if(!empty($file_contents)) return $file_contents;
	}

	// 通过curl模拟请求页面
	$ch = curl_init();
	// 设置超时时间
	$timeout = 30;
	curl_setopt($ch, CURLOPT_URL, $url);
	// 以下内容模拟来源及代理还有agent,避免被dns加速工具拦截
	curl_setopt($ch, CURLOPT_HTTPHEADER, array('X-FORWARDED-FOR:111.222.333.4', 'CLIENT-IP:111.222.333.4'));
	curl_setopt($ch, CURLOPT_REFERER, "http://www.baidu.com");
	//curl_setopt($ch, CURLOPT_PROXY, "http://111.222.333.4:110");
	curl_setopt($ch, CURLOPT_USERAGENT, "Mozilla/5.0 (Windows NT 6.1) AppleWebKit/536.11 (KHTML, like Gecko) Chrome/20.0.1132.57 Safari/536.11");
	curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
	curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, $timeout);
	$file_contents = curl_exec($ch);
	curl_close($ch);

	// 匹配出当前页的charset
	$charset = preg_match("/<meta.+?charset=[^\w]?([-\w]+)/i", $file_contents, $temp) ? strtolower($temp[1]) : "";
	//$title = preg_match("/<title>(.*)<\/title>/isU", $file_contents, $temp) ? $temp[1] : "";

	// 非utf8编码时转码
	if($charset != 'utf-8'){
		$file_contents = iconv(strtoupper($charset), "UTF-8", $file_contents);
	}
	// 将结果记录到session中，方便下次直接读取
	$_SESSION[$key] = $file_contents;

	return $file_contents;
}
/**
 * 判断是否手机
 * @return boolean
 */
function isMobile(){
	$useragent=isset($_SERVER['HTTP_USER_AGENT']) ? $_SERVER['HTTP_USER_AGENT'] : '';
	$useragent_commentsblock=preg_match('|\(.*?\)|',$useragent,$matches)>0?$matches[0]:'';
	function CheckSubstrs($substrs,$text){
		foreach($substrs as $substr)
			if(false!==strpos($text,$substr)){
			return true;
		}
		return false;
	}
	$mobile_os_list=array('Google Wireless Transcoder','Windows CE','WindowsCE','Symbian','Android','armv6l','armv5','Mobile','CentOS','mowser','AvantGo','Opera Mobi','J2ME/MIDP','Smartphone','Go.Web','Palm','iPAQ');
	$mobile_token_list=array('Profile/MIDP','Configuration/CLDC-','160×160','176×220','240×240','240×320','320×240','UP.Browser','UP.Link','SymbianOS','PalmOS','PocketPC','SonyEricsson','Nokia','BlackBerry','Vodafone','BenQ','Novarra-Vision','Iris','NetFront','HTC_','Xda_','SAMSUNG-SGH','Wapaka','DoCoMo','iPhone','iPod');

	$found_mobile=CheckSubstrs($mobile_os_list,$useragent_commentsblock) ||
	CheckSubstrs($mobile_token_list,$useragent);

	if ($found_mobile){
		return true;
	}else{
		return false;
	}
}

/**
 * 检测是否登录
 */
function is_login(){
	$user = session('user_auth');
	if (empty($user['id'])) {
		return 0;
	} else {
		return 1;
	}
} 
/**
 * 检查是否管理员
 */
function is_administrator(){
	$user = session('admin_auth');
	if (empty($user['id'])) {
		return 0;
	} else {
		return 1;
	}
}


/**
 * 时间戳格式化
 * @param int $time
 * @return string 完整的时间显示
 * @author huajie <banhuajie@163.com>
 */
function time_format($time = NULL,$format='Y-m-d H:i'){
	$time = $time === NULL ? NOW_TIME : intval($time);
	return date($format, $time);
}

/**
 * 字符串截取，支持中文和其他编码
 * @static
 * @access public
 * @param string $str 需要转换的字符串
 * @param string $start 开始位置
 * @param string $length 截取长度
 * @param string $charset 编码格式
 * @param string $suffix 截断显示字符
 * @return string
 */
function msubstr($str, $start=0, $length, $charset="utf-8", $suffix=true) {
	if(function_exists("mb_substr"))
		$slice = mb_substr($str, $start, $length, $charset);
	elseif(function_exists('iconv_substr')) {
		$slice = iconv_substr($str,$start,$length,$charset);
		if(false === $slice) {
			$slice = '';
		}
	}else{
		$re['utf-8']   = "/[\x01-\x7f]|[\xc2-\xdf][\x80-\xbf]|[\xe0-\xef][\x80-\xbf]{2}|[\xf0-\xff][\x80-\xbf]{3}/";
		$re['gb2312'] = "/[\x01-\x7f]|[\xb0-\xf7][\xa0-\xfe]/";
		$re['gbk']    = "/[\x01-\x7f]|[\x81-\xfe][\x40-\xfe]/";
		$re['big5']   = "/[\x01-\x7f]|[\x81-\xfe]([\x40-\x7e]|\xa1-\xfe])/";
		preg_match_all($re[$charset], $str, $match);
		$slice = join("",array_slice($match[0], $start, $length));
	}
	return $suffix ? $slice.'...' : $slice;
}